// Import functions from the Firebase SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    sendEmailVerification,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    orderBy, 
    onSnapshot, 
    doc, 
    setDoc, 
    deleteDoc, 
    where, 
    getDocs, 
    updateDoc
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAeHrxMwpArmteEWi4lIdTi54PYRDlLhks",
    authDomain: "dpflsite.firebaseapp.com",
    projectId: "dpflsite",
    storageBucket: "dpflsite.appspot.com",
    messagingSenderId: "884123413396",
    appId: "1:884123413396:web:fde6cb5f92bc1b23866fd81",
    measurementId: "G-5R72BVV5R7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- General UI Functions (Custom Alert) ---
const customAlert = document.getElementById('customAlert');
const customAlertMessage = document.getElementById('customAlertMessage');
const customAlertClose = document.getElementById('customAlertClose');

function showCustomAlert(message) {
    if(!customAlert || !customAlertMessage) return;
    customAlertMessage.textContent = message;
    customAlert.classList.add('active');
}

if(customAlertClose) {
    customAlertClose.addEventListener('click', () => {
        customAlert.classList.remove('active');
    });
}

// --- Authentication ---
const actionCodeSettings = {
    url: 'http://127.0.0.1:5500/login.html',
    handleCodeInApp: true
};

// Signup
const signupForm = document.getElementById('signup-form');
if (signupForm) {
    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = signupForm.username.value;
        const email = signupForm.email.value;
        const password = signupForm.password.value;
        const confirmPassword = signupForm['confirm-password'].value;

        if (password !== confirmPassword) {
            showCustomAlert('비밀번호가 일치하지 않습니다.');
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await sendEmailVerification(userCredential.user, actionCodeSettings);
            await setDoc(doc(db, "users", userCredential.user.uid), {
                username: username,
                email: email,
                createdAt: new Date()
            });
            await signOut(auth);
            // Redirect to the verification page
            window.location.href = 'verify-email.html';
        } catch (error) {
            console.error("Signup Error:", error);
            showCustomAlert("회원가입 실패: " + error.message);
        }
    });
}

// Login
const loginForm = document.getElementById('login-form');
if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginForm.email.value;
        const password = loginForm.password.value;
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            if (!userCredential.user.emailVerified) {
                await signOut(auth);
                showCustomAlert("이메일 인증이 필요합니다. 메일을 확인하세요.");
            } else {
                showCustomAlert("로그인 성공!");
                window.location.href = 'index.html';
            }
        } catch (error) {
            console.error("Login Error:", error);
            showCustomAlert("로그인 실패: " + error.message);
        }
    });
}

// Auth State Observer
onAuthStateChanged(auth, user => {
    const navLinks = document.querySelector('.nav-links');
    if (navLinks) {
        if (user && user.emailVerified) {
            console.log('User is logged in:', user.email);
            navLinks.innerHTML = `
                <li><a href="team_ranking.html">팀 순위</a></li>
                <li><a href="register_player.html">선수 등록</a></li>
                <li><a href="register_team.html">팀 등록</a></li>
                <li><a href="mypage.html">마이페이지</a></li>
                <li><a href="#" id="logout-btn">로그아웃</a></li>
            `;
            document.getElementById('logout-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                await signOut(auth);
                showCustomAlert('로그아웃되었습니다.');
                window.location.href = 'index.html';
            });
        } else {
            console.log('User is logged out or not verified.');
            navLinks.innerHTML = `
                <li><a href="login.html">로그인</a></li>
                <li><a href="team_ranking.html">팀 순위</a></li>
            `;
        }
        navLinks.style.display = 'flex'; // Make nav links visible after state is determined
    }

    // Load MyPage data if on MyPage
    if (window.location.pathname.endsWith('mypage.html')) {
        if (user && user.emailVerified) {
            loadMyPageData(user.uid);
        } else {
            showCustomAlert("로그인 후 마이페이지를 이용할 수 있습니다.");
            window.location.href = 'login.html';
        }
    }
});

// --- Access Control ---
function redirectToLoginIfNotAuthenticated() {
    onAuthStateChanged(auth, user => {
        if (!user || !user.emailVerified) {
            const currentPage = window.location.pathname.split('/').pop();
            if (currentPage !== 'login.html' && currentPage !== 'signup.html' && currentPage !== 'verify-email.html') {
                showCustomAlert('로그인 후 이용해주세요.');
                window.location.href = 'login.html';
            }
        }
    });
}

// Call access control for specific pages
if (window.location.pathname.endsWith('register_player.html')) {
    redirectToLoginIfNotAuthenticated();
}

if (window.location.pathname.endsWith('register_team.html')) {
    redirectToLoginIfNotAuthenticated();
}


// --- Team and Player Registration ---
const playerRegisterForm = document.getElementById('player-register-form');
if(playerRegisterForm){
    playerRegisterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const playerName = playerRegisterForm['player-name'].value;
        const playerProfile = playerRegisterForm['player-profile'].value;

        // Removed if(!auth.currentUser) check here, handled by redirectToLoginIfNotAuthenticated()

        try {
            await addDoc(collection(db, "pendingPlayers"), {
                name: playerName,
                profile: playerProfile,
                submitterUid: auth.currentUser.uid, // Store the UID of the user who submitted the request
                requestedAt: new Date()
            });
            showCustomAlert('선수 등록 요청이 완료되었습니다. 관리자 승인을 기다려주세요.');
            playerRegisterForm.reset();
        } catch (error) {
            console.error("Player registration error:", error);
            showCustomAlert('오류가 발생했습니다. 다시 시도해주세요.');
        }
    });
}

const teamRegisterForm = document.getElementById('team-register-form');
if(teamRegisterForm){
    teamRegisterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const teamName = teamRegisterForm['team-name'].value;
        const teamDesc = teamRegisterForm['team-description'].value;
        const iconFile = teamRegisterForm['team-icon'].files[0]; // This will be undefined if no file is selected

        // Removed if(!auth.currentUser) check here, handled by redirectToLoginIfNotAuthenticated()

        let downloadURL = null; // Initialize downloadURL as null

        try {
            if (iconFile) { // Only upload if a file is selected
                const storageRef = ref(storage, `team-icons/${Date.now()}_${iconFile.name}`);
                await uploadBytes(storageRef, iconFile);
                downloadURL = await getDownloadURL(storageRef);
            }
            
            // Add to 'pendingTeams' collection for admin approval
            await addDoc(collection(db, "pendingTeams"), {
                name: teamName,
                description: teamDesc,
                iconUrl: downloadURL, // Will be null if no file was uploaded
                leader: auth.currentUser.uid, // Add leader UID
                requestedAt: new Date()
            });
            showCustomAlert('팀 등록 요청이 완료되었습니다. 관리자 승인을 기다려주세요.');
            teamRegisterForm.reset();
        } catch (error) {
            console.error("Team registration error:", error);
            showCustomAlert('오류가 발생했습니다. 다시 시도해주세요.');
        }
    });
}

// --- Data Fetching ---
const rankingBody = document.getElementById('ranking-body');
if (rankingBody) {
    const q = query(collection(db, "teams"), orderBy("승점", "desc"));
    onSnapshot(q, (querySnapshot) => {
        rankingBody.innerHTML = '';
        if(querySnapshot.empty){
            rankingBody.innerHTML = '<tr><td colspan="10">아직 등록된 팀이 없습니다.</td></tr>';
            return;
        }
        let rank = 1;
        querySnapshot.forEach((doc) => {
            const team = doc.data();
            const row = document.createElement('tr');
            const 득실 = (team.득점 || 0) - (team.실점 || 0);
            row.innerHTML = `
                <td>${rank}</td>
                <td>${team.name}</td>
                <td>${team.경기수 || 0}</td>
                <td>${team.승점 || 0}</td>
                <td>${team.승 || 0}</td>
                <td>${team.무 || 0}</td>
                <td>${team.패 || 0}</td>
                <td>${team.득점 || 0}</td>
                <td>${team.실점 || 0}</td>
                <td>${득실}</td>
            `;
            rankingBody.appendChild(row);
            rank++;
        });
    }, (error) => {
        console.error("Error fetching rankings: ", error);
        rankingBody.innerHTML = '<tr><td colspan="10">순위를 불러오는 데 실패했습니다.</td></tr>';
    });
}

// --- MyPage Functions ---
let currentRecruitingTeamId = null;
let currentRecruitingTeamName = null;

async function loadMyPageData(uid) {
    const myTeamsList = document.getElementById('my-teams-list');
    const myPlayerProfile = document.getElementById('my-player-profile');

    // Load My Teams
    if (myTeamsList) {
        myTeamsList.innerHTML = '<p class="no-data">팀 정보를 불러오는 중...</p>';
        try {
            const q = query(collection(db, "teams"), where("leader", "==", uid));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                myTeamsList.innerHTML = '<p class="no-data">아직 등록된 팀이 없습니다.</p>';
            } else {
                myTeamsList.innerHTML = '';
                querySnapshot.forEach((docSnapshot) => {
                    const team = docSnapshot.data();
                    const teamId = docSnapshot.id;
                    const div = document.createElement('div');
                    div.className = 'team-item';
                    div.innerHTML = `
                        ${team.iconUrl ? `<img src="${team.iconUrl}" alt="${team.name} Icon">` : ''}
                        <div class="item-details">
                            <h3>${team.name}</h3>
                            <p>${team.description}</p>
                        </div>
                        <button class="edit-btn" data-id="${teamId}" data-type="team">수정</button>
                        <button class="recruit-btn" data-id="${teamId}" data-name="${team.name}">선수 영입</button>
                    `;
                    myTeamsList.appendChild(div);
                });
            }
        } catch (error) {
            console.error("Error loading my teams:", error);
            myTeamsList.innerHTML = '<p class="no-data">팀 정보를 불러오는 데 실패했습니다.</p>';
        }
    }

    // Load My Player Profile
    if (myPlayerProfile) {
        myPlayerProfile.innerHTML = '<p class="no-data">선수 정보를 불러오는 중...</p>';
        try {
            // Query players collection where uid matches the current user's uid
            const q = query(collection(db, "players"), where("uid", "==", uid));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                myPlayerProfile.innerHTML = '<p class="no-data">아직 등록된 선수 정보가 없습니다.</p>';
            } else {
                myPlayerProfile.innerHTML = '';
                querySnapshot.forEach((docSnapshot) => {
                    const player = docSnapshot.data();
                    const playerId = docSnapshot.id;
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    div.innerHTML = `
                        <div class="item-details">
                            <h3>${player.name}</h3>
                            <p>${player.profile}</p>
                            <p>소속팀: ${player.teamName || '무소속'}</p>
                        </div>
                        <button class="edit-btn" data-id="${playerId}" data-type="player">수정</button>
                    `;
                    myPlayerProfile.appendChild(div);
                });
            }
        } catch (error) {
            console.error("Error loading my player profile:", error);
            myPlayerProfile.innerHTML = '<p class="no-data">선수 정보를 불러오는 데 실패했습니다.</p>';
        }
    }

    // Setup edit modal listeners
    setupEditModals();
    setupRecruitModals(); // New: Setup recruit modal listeners
}

function setupEditModals() {
    const teamEditModal = document.getElementById('teamEditModal');
    const playerEditModal = document.getElementById('playerEditModal');
    const closeButtons = document.querySelectorAll('.close-button');

    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            teamEditModal.style.display = 'none';
            playerEditModal.style.display = 'none';
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target == teamEditModal) {
            teamEditModal.style.display = 'none';
        }
        if (event.target == playerEditModal) {
            playerEditModal.style.display = 'none';
        }
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;

            if (type === 'team') {
                const teamDocRef = doc(db, "teams", id);
                const teamDocSnap = await getDoc(teamDocRef); // Use getDoc for single document
                if (teamDocSnap.exists()) {
                    const teamData = teamDocSnap.data();
                    document.getElementById('editTeamId').value = id;
                    document.getElementById('editTeamName').value = teamData.name;
                    document.getElementById('editTeamDescription').value = teamData.description;
                    teamEditModal.style.display = 'flex';
                } else {
                    showCustomAlert('팀 정보를 찾을 수 없습니다.');
                }
            } else if (type === 'player') {
                const playerDocRef = doc(db, "players", id);
                const playerDocSnap = await getDoc(playerDocRef); // Use getDoc for single document
                if (playerDocSnap.exists()) {
                    const playerData = playerDocSnap.data();
                    document.getElementById('editPlayerId').value = id;
                    document.getElementById('editPlayerName').value = playerData.name;
                    document.getElementById('editPlayerProfile').value = playerData.profile;
                    playerEditModal.style.display = 'flex';
                }
            } else {
                showCustomAlert('알 수 없는 수정 타입입니다.');
            }
        });
    });

    // Save Team Edits
    const editTeamForm = document.getElementById('editTeamForm');
    if(editTeamForm) {
        editTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamId = document.getElementById('editTeamId').value;
            const newName = document.getElementById('editTeamName').value;
            const newDescription = document.getElementById('editTeamDescription').value;
            const newIconFile = document.getElementById('editTeamIcon').files[0];

            try {
                let updatedData = { name: newName, description: newDescription };
                if (newIconFile) {
                    const storageRef = ref(storage, `team-icons/${Date.now()}_${newIconFile.name}`);
                    await uploadBytes(storageRef, newIconFile);
                    updatedData.iconUrl = await getDownloadURL(storageRef);
                }
                await updateDoc(doc(db, "teams", teamId), updatedData);
                showCustomAlert('팀 정보가 성공적으로 업데이트되었습니다.');
                teamEditModal.style.display = 'none';
            } catch (error) {
                console.error("Error updating team:", error);
                showCustomAlert('팀 정보 업데이트에 실패했습니다.');
            }
        });
    }

    // Save Player Edits
    const editPlayerForm = document.getElementById('editPlayerForm');
    if(editPlayerForm) {
        editPlayerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const playerId = document.getElementById('editPlayerId').value;
            const newName = document.getElementById('editPlayerName').value;
            const newProfile = document.getElementById('editPlayerProfile').value;

            try {
                await updateDoc(doc(db, "players", playerId), { name: newName, profile: newProfile });
                showCustomAlert('선수 정보가 성공적으로 업데이트되었습니다.');
                playerEditModal.style.display = 'none';
            } catch (error) {
                console.error("Error updating player:", error);
                showCustomAlert('선수 정보 업데이트에 실패했습니다.');
            }
        });
    }
}

// --- Recruit Player Functions ---
const recruitPlayerModal = document.getElementById('recruitPlayerModal');
const unassignedPlayersList = document.getElementById('unassigned-players-list');
let currentRecruitingTeamId = null;
let currentRecruitingTeamName = null;

function setupRecruitModals() {
    document.querySelectorAll('.recruit-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            currentRecruitingTeamId = e.target.dataset.id;
            currentRecruitingTeamName = e.target.dataset.name;
            recruitPlayerModal.style.display = 'flex';
            loadUnassignedPlayers();
        });
    });

    // Close button for recruit modal
    const recruitModalCloseButton = recruitPlayerModal.querySelector('.close-button');
    if (recruitModalCloseButton) {
        recruitModalCloseButton.addEventListener('click', () => {
            recruitPlayerModal.style.display = 'none';
        });
    }

    // Close when clicking outside modal
    window.addEventListener('click', (event) => {
        if (event.target == recruitPlayerModal) {
            recruitPlayerModal.style.display = 'none';
        }
    });
}

async function loadUnassignedPlayers() {
    if (!unassignedPlayersList) return;
    unassignedPlayersList.innerHTML = '<p class="no-data">로딩 중...</p>';
    try {
        const q = query(collection(db, "players"), where("teamName", "==", "무소속"));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
            unassignedPlayersList.innerHTML = '<p class="no-data">영입할 무소속 선수가 없습니다.</p>';
        } else {
            unassignedPlayersList.innerHTML = '';
            querySnapshot.forEach((docSnapshot) => {
                const player = docSnapshot.data();
                const playerId = docSnapshot.id;
                const div = document.createElement('div');
                div.className = 'player-item'; // Re-use player-item style
                div.innerHTML = `
                    <div class="item-details">
                        <h3>${player.name}</h3>
                        <p>${player.profile}</p>
                    </div>
                    <button class="recruit-player-btn" data-id="${playerId}" data-name="${player.name}">영입</button>
                `;
                unassignedPlayersList.appendChild(div);
            });
            // Attach event listeners to newly created recruit buttons
            document.querySelectorAll('.recruit-player-btn').forEach(button => {
                button.addEventListener('click', recruitPlayer);
            });
        }
    } catch (error) {
        console.error("Error loading unassigned players:", error);
        unassignedPlayersList.innerHTML = '<p class="no-data">선수 목록을 불러오는 데 실패했습니다.</p>';
    }
}

async function recruitPlayer(e) {
    const playerId = e.target.dataset.id;
    const playerName = e.target.dataset.name;

    if (!currentRecruitingTeamId || !currentRecruitingTeamName) {
        showCustomAlert('팀 정보가 올바르지 않습니다. 다시 시도해주세요.');
        return;
    }

    try {
        await updateDoc(doc(db, "players", playerId), {
            teamId: currentRecruitingTeamId,
            teamName: currentRecruitingTeamName
        });
        showCustomAlert(`${playerName} 선수를 ${currentRecruitingTeamName} 팀으로 영입했습니다!`);
        recruitPlayerModal.style.display = 'none';
        // Refresh MyPage data to show updated player info
        if (auth.currentUser && auth.currentUser.emailVerified) {
            loadMyPageData(auth.currentUser.uid);
        }
    } catch (error) {
        console.error("Error recruiting player:", error);
        showCustomAlert('선수 영입에 실패했습니다.');
    }
}

// --- Admin Panel ---
if (window.location.pathname.endsWith('admin.html')) {
    const password = prompt("관리자 비밀번호를 입력하세요:");
    if (password === "admin123") {
        const adminContent = document.getElementById('admin-content');
        if(adminContent) adminContent.style.display = 'block';
        loadPendingItems('pendingPlayers', 'pending-players', '선수');
        loadPendingItems('pendingTeams', 'pending-teams', '팀'); // Re-enable loading pending teams
    } else {
        showCustomAlert("비밀번호가 틀렸습니다.");
        window.location.href = 'index.html';
    }
}

async function loadPendingItems(collectionName, elementId, itemType) {
    const container = document.getElementById(elementId);
    if(!container) return;

    const q = query(collection(db, collectionName));
    onSnapshot(q, (snapshot) => {
        container.innerHTML = '';
        if(snapshot.empty){
            container.innerHTML = `<p>승인 대기중인 ${itemType}이(가) 없습니다.</p>`;
            return;
        }
        snapshot.forEach(docSnapshot => {
            const item = docSnapshot.data();
            const div = document.createElement('div');
            div.className = 'pending-item';
            let content = `<p><strong>${itemType} 이름:</strong> ${item.name}</p>`;
            if(item.profile) content += `<p><strong>프로필:</strong> ${item.profile}</p>`;
            if(item.description) content += `<p><strong>설명:</strong> ${item.description}</p>`;
            if(item.iconUrl) content += `<img src="${item.iconUrl}" width="50" alt="Team Icon">`;
            div.innerHTML = content;

            const approveBtn = document.createElement('button');
            approveBtn.textContent = '승인';
            approveBtn.onclick = () => approveItem(collectionName, docSnapshot.id, item);
            div.appendChild(approveBtn);

            const rejectBtn = document.createElement('button');
            rejectBtn.textContent = '거절';
            rejectBtn.style.marginLeft = '10px';
            rejectBtn.onclick = () => rejectItem(collectionName, docSnapshot.id);
            div.appendChild(rejectBtn);

            container.appendChild(div);
        });
    });
}

async function approveItem(collectionName, docId, itemData) {
    try {
        if(collectionName === 'pendingPlayers') {
            // Add player to 'players' collection with initial 'unassigned' team status
            // Use itemData.submitterUid for the player's UID
            await addDoc(collection(db, 'players'), { ...itemData, teamId: null, teamName: '무소속', uid: itemData.submitterUid }); 
        } else if (collectionName === 'pendingTeams') { // Re-add logic for pendingTeams
            const teamData = { 
                ...itemData, 
                경기수: 0, 승점: 0, 승: 0, 무: 0, 패: 0, 득점: 0, 실점: 0 
            };
            await addDoc(collection(db, 'teams'), teamData);
        }
        await deleteDoc(doc(db, collectionName, docId));
        showCustomAlert('성공적으로 승인되었습니다.');
    } catch (error) {
        console.error('Approval Error:', error);
        showCustomAlert('승인 중 오류가 발생했습니다.');
    }
}

async function rejectItem(collectionName, docId) {
    try {
        await deleteDoc(doc(db, collectionName, docId));
        showCustomAlert('성공적으로 거절되었습니다.');
    } catch (error) {
        console.error('Rejection Error:', error);
        showCustomAlert('거절 중 오류가 발생했습니다.');
    }
}
